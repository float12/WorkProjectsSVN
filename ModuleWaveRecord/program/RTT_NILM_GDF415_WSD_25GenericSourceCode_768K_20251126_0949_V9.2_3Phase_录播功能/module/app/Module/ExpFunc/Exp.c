//----------------------------------------------------------------------
//Copyright (C) 2003-20XX 烟台东方威思顿电气有限公司电表软件研发部
//创建人	zh
//创建日期	
//描述		
//修改记录
//----------------------------------------------------------------------
#include "AllHead.h"
#include <rtthread.h>
#include "sm_api.h"
#include "Dlt698_45.h"
#include "task_update.h"
#include "gd25q64c.h"
//-----------------------------------------------
//			本文件使用的宏定义
//-----------------------------------------------

//-----------------------------------------------
//		本文件使用的结构体，共用体，枚举
//-----------------------------------------------
#pragma pack(1)
typedef struct TAlgrothmPara_t
{
	BYTE  Id[12];
	BYTE  Parameter[128];
}TAlgrothmPara;
#pragma pack()

//目前现有芯片的算法参数，后续可以维护此表格
TAlgrothmPara gTAlgrothmPara[] = 
{
	//自测使用256K
	{
		{0xAF, 0x23, 0x33, 0x30, 0x38, 0x33, 0x34, 0x0C, 0x33, 0x33, 0x35, 0x34},
		{0x1e,0xaa,0x60,0x7e,0x1b,0x42,0x19,0x22,0xe1,0x0e,0xed,0x58,0x75,0xca,0x6b,0x28,0x13,0x8a,0xce,0x3c,0xbb,0x52,0x35,0xff,0xd0,0x0b,0xe1,0xd4,0xd2,0xb6,0x64,0x6e,0xa0,0xfa,0x7a,0x8e,0x96,0x89,0xb0,0xeb,0x55,0xa9,0x82,0x1e,0x79,0x42,0x03,0x29,0x32,0xc9,0x84,0xd8,0x86,0x5c,0xf3,0x0d,0x19,0x71,0x91,0x0b,0x47,0xc2,0x19,0x56,0x15,0xa9,0x20,0x51,0xfb,0x8d,0x27,0x94,0x16,0x12,0x0e,0xe3,0xc1,0x2f,0x6a,0xe5,0xde,0xa9,0x33,0x01,0x60,0x22,0xbe,0xd1,0x79,0x85,0x2a,0x75,0x3c,0xed,0x84,0x16,0x93,0x18,0xec,0xef,0x26,0x37,0xd9,0x49,0xd2,0x58,0x82,0x6b,0xf1,0x11,0xbe,0x49,0xd6,0xab,0x9a,0x4f,0x5d,0x2f,0x06,0xe2,0x42,0x46,0x9b,0x91,0x68,0x8b,0xbc,0xf7}
	},

	//自测使用（高）
	{
		{0x7D, 0x36, 0x33, 0x31, 0x35, 0x35, 0x34, 0x05, 0x50, 0x30, 0x35, 0x36},
		{0x8e,0x5a,0xc3,0x1b,0x15,0x24,0x89,0xc8,0x92,0x3d,0x10,0x9,0x49,0x3f,0x61,0x62,0xe3,0x48,0xab,0x43,0x1a,0xd,0xad,0x9d,0x24,0x35,0x69,0xeb,0x1c,0x7b,0x59,0x9e,0xeb,0x7c,0x84,0x21,0x6c,0xd6,0x16,0xd1,0xa6,0xb7,0x45,0x4a,0x7a,0xd6,0xe9,0xf9,0xa7,0xe2,0xc3,0x16,0x98,0xb3,0x4d,0x8a,0x76,0xcc,0x73,0xb6,0xc4,0x95,0xdd,0xd,0x3f,0xc9,0x46,0xd4,0xa,0xd8,0xd7,0x41,0x27,0xa1,0xa1,0xa,0x44,0x3d,0xc9,0xc6,0x3e,0x78,0xf7,0x31,0x18,0x48,0x8f,0xc7,0xaa,0x42,0x2c,0xd3,0x5a,0xf,0xf6,0xb8,0xe8,0x30,0xce,0x5d,0xfe,0x94,0x81,0x47,0xde,0xe9,0x61,0xf7,0x3a,0x9b,0x2,0x88,0x9,0x2d,0x7a,0x12,0x68,0x27,0x1,0xfe,0x89,0x7d,0x91,0x61,0xdc,0x9d,0x6c,0x9d}
	},

	//测试组使用1
	{
		{0x33, 0x32, 0x33, 0x31, 0x35, 0x35, 0x34, 0x05, 0x50, 0x30, 0x35, 0x36},
		{0xa3,0x8a,0xc8,0x14,0x75,0x3b,0xbd,0x9e,0x89,0x35,0xb9,0xc5,0x37,0xe4,0x6d,0x76,0x3e,0xe7,0x03,0xc8,0xc1,0x98,0x3f,0xfb,0xa6,0x57,0x6c,0x45,0xad,0xf1,0x8b,0x97,0x06,0xf8,0x3a,0xba,0x68,0x3e,0x11,0x52,0xd8,0x71,0x5d,0xc6,0x29,0xba,0x3a,0x44,0x7c,0x70,0x7b,0xae,0x99,0x7a,0x68,0xff,0x5e,0x3a,0xf9,0xef,0x28,0xf4,0xd0,0x27,0x02,0x13,0x69,0xe9,0x85,0x6a,0x6c,0x92,0xe0,0xb2,0xe8,0x27,0x34,0xc7,0x61,0x2c,0x78,0xe3,0x5a,0x56,0xdc,0xa8,0x1f,0xf3,0x32,0x62,0x9e,0xa7,0xdd,0xa4,0x80,0x58,0x7c,0x5e,0x23,0x71,0x60,0x5b,0x1e,0xb8,0xad,0xb9,0xdf,0x33,0x3d,0x77,0x10,0x3e,0xac,0xe7,0xe9,0x30,0x8a,0x66,0x46,0xd2,0xed,0x14,0x8c,0x15,0xd7,0xa0,0xcb,0x55}
	},

	//测试组使用2
	{
		{0x76, 0x38, 0x33, 0x31, 0x35, 0x35, 0x34, 0x05, 0x50, 0x30, 0x35, 0x36},
		{0xa5,0x87,0x35,0xb8,0x45,0x7d,0x75,0x69,0x7c,0x65,0xf2,0xdf,0x18,0x7c,0x27,0xd3,0x73,0xa8,0xeb,0x0d,0x0d,0x3f,0x5c,0x50,0x0a,0x7b,0x5e,0xc4,0x09,0xbb,0xa0,0x9c,0x34,0x78,0xd2,0xd3,0xcb,0x22,0x72,0xc3,0x1e,0x73,0x15,0x4b,0x36,0xf5,0x5c,0x3f,0x26,0xc6,0x6f,0x15,0xfa,0xb1,0x3c,0x1d,0x81,0xdb,0xd3,0x35,0x8a,0xcc,0x8a,0xd6,0x6e,0x43,0x90,0x8c,0x09,0x27,0xf0,0xe2,0x9f,0x29,0x75,0x4d,0x15,0xd2,0xb7,0x6f,0xa2,0xac,0xb8,0x9b,0x79,0x16,0x1a,0x2e,0xe8,0x01,0x7d,0x23,0xf1,0xd8,0xec,0xb3,0x2f,0xeb,0x2d,0x95,0x4d,0x14,0x2c,0x63,0x61,0xe1,0x6f,0x9b,0x27,0x6f,0x45,0x78,0x47,0xfa,0x11,0x45,0x6f,0x32,0xfd,0x54,0x86,0xdf,0x7c,0x02,0x0c,0x59,0xe0,0x80}
	},

	//自测使用（NILM768）
	{
		{0xB6, 0x3B, 0x33, 0x31, 0x35, 0x35, 0x34, 0x05, 0x50, 0x30, 0x35, 0x36},
		{0X40,0X3a,0X25,0X7a,0Xdf,0X7b,0X95,0X18,0X54,0Xe2,0X63,0Xb2,0Xba,0X27,0X94,0Xfd,0X6c,0Xea,0X23,0Xa4,0X6f,0Xa3,0X66,0X76,0X65,0Xba,0X32,0X1e,0Xbd,0Xa1,0X87,0Xed,0Xf3,0X6b,0X62,0X20,0X9d,0Xcc,0Xdd,0X47,0Xad,0X15,0X38,0Xd7,0X5a,0Xd5,0Xf9,0Xbb,0Xe1,0X02,0Xbd,0Xa0,0Xc8,0X26,0Xe6,0X19,0Xa2,0X9c,0X47,0X95,0X85,0Xaa,0X5d,0X65,0Xac,0X46,0Xbb,0X9e,0Xd7,0X18,0Xbf,0X74,0Xd3,0Xf4,0X46,0X6d,0X0a,0Xc3,0X73,0X20,0Xf3,0X2e,0X20,0X84,0X18,0X17,0X2b,0X0c,0X89,0Xb5,0Xd2,0X5f,0Xe8,0X9a,0X53,0X10,0X72,0Xc0,0Xfa,0Xb4,0X8e,0X36,0Xba,0X44,0X97,0Xfc,0X99,0X0b,0Xbd,0X7e,0Xe9,0X87,0Xf7,0Xd7,0X0b,0X37,0X78,0Xf0,0X22,0X75,0Xde,0Xf4,0X34,0X41,0X74,0X70,0X4f,0X77}
	},

	//768K 1
	{
		{0xAF,0x37,0x33,0x31,0x35,0x35,0x34,0x05,0x50,0x30,0x35,0x36},
		{0x98,0x50,0xe9,0xbc,0x67,0xb0,0x23,0x61,0x92,0xb9,0x74,0x6f,0xed,0x94,0xc5,0xd7,0x0e,0x80,0x3c,0x5c,0x21,0x46,0xc5,0xb0,0x10,0x07,0xd0,0x8e,0x58,0x99,0x2b,0x9e,0x8f,0x08,0xe7,0xa2,0xc7,0x2d,0xa4,0x94,0x33,0x2e,0x94,0xc5,0xe7,0xea,0x2b,0x11,0x5d,0xa9,0x84,0x48,0x0f,0x96,0xdd,0xeb,0x2b,0x1d,0x51,0x4c,0x05,0x76,0xcd,0x13,0x63,0x61,0x4d,0x99,0x66,0xf8,0xf8,0x95,0xd5,0x31,0xeb,0x97,0x6e,0xcf,0xe5,0x8d,0x4c,0x6b,0x57,0x01,0x55,0x7c,0x4c,0x21,0xff,0x46,0xe2,0x99,0x9b,0xd3,0xee,0x05,0xe1,0xa8,0x78,0xc6,0x3d,0xf7,0xf7,0x98,0x82,0x21,0x8d,0x67,0x6a,0x20,0x98,0x41,0xc8,0x16,0x8e,0xf8,0xc2,0xa4,0x95,0x85,0xb6,0xa3,0x9b,0xdc,0x3a,0x93,0xf9,0xb4}
	},

	//768K 2
	{
		{0xB2,0x33,0x33,0x31,0x35,0x35,0x34,0x05,0x50,0x30,0x35,0x36},
		{0x6f,0xbf,0x21,0xab,0xe1,0x30,0x94,0xab,0xca,0xd8,0xac,0x6f,0x5a,0x85,0xe1,0x6b,0x51,0x45,0x9d,0xcd,0xfb,0xd9,0x20,0xf8,0x72,0x17,0xda,0xa4,0x1d,0x8f,0xec,0xa2,0x06,0xef,0x1f,0x83,0xe3,0x76,0xad,0x13,0x93,0xc2,0x18,0xcc,0x00,0xb0,0x20,0xb7,0x70,0x87,0xde,0xe8,0xbb,0xcc,0x56,0xc6,0x3d,0xd8,0x68,0x91,0xbc,0x73,0x91,0xc0,0xeb,0x36,0x4b,0x41,0x38,0x86,0x8f,0xf9,0x13,0x31,0x0c,0x35,0xc9,0x37,0x76,0x50,0x91,0x7b,0x69,0x58,0xc9,0xb6,0xb7,0x15,0x04,0xff,0x72,0xc1,0xac,0x31,0x95,0xf2,0x59,0x64,0x6f,0x84,0xc1,0x3e,0xb0,0x3f,0x88,0x82,0x59,0xb5,0x0c,0xb6,0xf5,0xc7,0xb2,0x3d,0x1e,0x5a,0xdb,0x17,0x04,0xca,0xec,0x08,0x8f,0xea,0x75,0x4b,0xd6,0x80}
	},

	//768K 3
	{
		{0xC3,0x36,0x33,0x31,0x35,0x35,0x34,0x05,0x50,0x30,0x35,0x36},
		{0x66,0x02,0x6a,0x35,0x63,0x20,0xdf,0x6a,0x6d,0x68,0x69,0x53,0x2c,0x58,0xea,0x04,0x9f,0xc6,0x02,0xe1,0x0f,0x63,0xb9,0x80,0xe3,0x9d,0x7a,0x5d,0x4a,0x78,0x82,0xcc,0x4e,0x40,0xef,0xb0,0xe7,0x79,0x62,0xd4,0x0a,0x6f,0xbe,0x07,0x91,0x59,0x90,0xbf,0xc8,0x43,0xe6,0x77,0x9b,0x33,0x28,0xd7,0xcf,0xf3,0x1d,0x8a,0x8e,0xe6,0xda,0x3c,0x1a,0xef,0x8b,0xd7,0x10,0x9d,0xc7,0xec,0x12,0x93,0xef,0xc7,0x11,0x95,0x8a,0x67,0xab,0x4c,0x08,0xb7,0x28,0x0f,0xec,0x07,0x27,0xd0,0x1c,0x4c,0xd0,0x57,0x65,0xea,0x10,0xbb,0xc7,0x30,0xc4,0xf5,0xc1,0xa8,0xe2,0x78,0x1b,0x33,0x67,0x30,0xdc,0xcb,0x05,0x5a,0x84,0x3e,0x08,0x4b,0xc8,0xea,0x1a,0x99,0x7b,0xf5,0x27,0x13,0xa9,0x6f}
	},

	//768K 4
	{
		{0x83,0x31,0x33,0x31,0x35,0x35,0x34,0x05,0x50,0x30,0x35,0x36},
		{0x19,0x10,0xd5,0xd6,0x4a,0xca,0x5b,0xe6,0x8f,0xbe,0x78,0xba,0xd7,0x47,0xe9,0xa9,0x1f,0x34,0x51,0x9d,0xb4,0xa9,0x4b,0xc0,0x03,0x38,0x8b,0x76,0x65,0x64,0x26,0x2a,0x9d,0xe3,0x83,0xf8,0xb8,0xb8,0x65,0xab,0x3e,0xde,0x7a,0xf6,0x2f,0x6b,0x05,0x0c,0x8f,0x5a,0xbf,0x42,0x03,0x6e,0x1e,0xd1,0x24,0x5e,0xb7,0xf2,0x23,0x7f,0xd1,0x85,0xf3,0x60,0xb4,0x78,0x15,0x88,0xd0,0xd6,0x27,0x0c,0x10,0x73,0x1d,0x4a,0xbb,0x29,0xa5,0x89,0x74,0x6d,0x68,0xc2,0xfc,0x7a,0x7e,0x45,0x04,0x8e,0xd2,0xfb,0x6d,0x59,0x77,0x4f,0x7d,0x78,0x1e,0xdb,0xb1,0xc5,0xcc,0xd6,0xa1,0x78,0xa2,0xc2,0x62,0x00,0x7c,0xe4,0x8d,0xdb,0x00,0xf4,0xfd,0x25,0x50,0x10,0x0c,0x67,0xcb,0xac,0x63,0xc0}
	},

	//768K 5
	{
		{0x41,0x32,0x33,0x31,0x35,0x35,0x34,0x05,0x50,0x30,0x35,0x36},
		{0x97,0x11,0x1d,0x24,0x09,0x50,0x20,0x94,0xc5,0xfe,0x5c,0xd1,0xf7,0xa1,0xa0,0x17,0x3d,0x09,0x3e,0xf1,0xf0,0xfc,0xbc,0x44,0xbc,0x9f,0xab,0xef,0xf5,0x00,0xcf,0xa0,0x1a,0x8a,0xac,0x58,0x08,0x2a,0x43,0xd4,0xb2,0xd0,0x60,0x78,0xd4,0xcd,0x1e,0x6f,0x16,0xa8,0x79,0x91,0x55,0xe7,0xb6,0xce,0xd4,0x6a,0xce,0xfb,0x56,0x81,0x27,0x44,0xeb,0x72,0xd0,0x2a,0x36,0x03,0xf0,0x54,0x9a,0xc9,0xfb,0xb2,0x50,0x01,0x23,0x42,0x39,0x2d,0x55,0x71,0xbe,0x6a,0x48,0x08,0x44,0x22,0x1b,0x88,0x83,0xc5,0x09,0x92,0xab,0x6b,0x6a,0x1e,0x25,0x94,0x61,0x35,0x01,0xa3,0xfb,0x1c,0xab,0x00,0xb1,0x88,0x62,0x5c,0x61,0x5d,0x25,0xcd,0xad,0x07,0xe1,0x6c,0x79,0x09,0x89,0xf2,0x94,0xce}
	},

	//768K 6
	{
		{0x23,0x37,0x33,0x31,0x35,0x35,0x34,0x05,0x50,0x30,0x35,0x36},
		{0xba,0xe4,0x79,0x00,0x34,0x9c,0x37,0xbd,0x70,0x96,0x0c,0xc3,0xd2,0x10,0x08,0x2c,0x8f,0x20,0x32,0x1b,0x73,0x6a,0x05,0x24,0x33,0x99,0x57,0x2e,0x0c,0xee,0x28,0xbd,0x01,0x3a,0x22,0xc9,0xb2,0x8d,0x20,0xd8,0x7b,0xbd,0x36,0xe7,0xfa,0xa2,0x86,0xcd,0x5f,0x46,0xf7,0xe5,0x78,0x93,0x75,0x69,0x38,0x12,0x88,0xd8,0x6f,0xb4,0x2a,0xf4,0x18,0xe5,0xcf,0x60,0x87,0xc3,0x6b,0x7c,0xb8,0xaa,0xb2,0x2a,0x63,0x4d,0x95,0x7b,0xb7,0x83,0x13,0x27,0xe8,0xb3,0x0f,0x41,0x0f,0x9b,0xb4,0x40,0x9e,0xe9,0xb6,0x2d,0x3c,0x68,0x83,0x44,0x15,0xaf,0x36,0xda,0x6e,0x5d,0x42,0x9d,0x33,0x1f,0x9b,0x7e,0x57,0xdf,0xeb,0xa8,0x92,0x1a,0x08,0x60,0x74,0x75,0xb7,0x59,0xf8,0x32,0x8a,0xc5}
	},

	//768K 7
	{
		{0xB8,0x3C,0x33,0x31,0x35,0x35,0x34,0x05,0x50,0x30,0x35,0x36},
		{0x4b,0xe9,0xbe,0x4e,0x13,0x30,0x21,0xea,0xa6,0xa8,0x9c,0xdc,0xcd,0xdf,0xd3,0xa2,0x40,0x23,0x02,0x39,0x2f,0xb8,0x94,0xcd,0x14,0xc1,0xf8,0x67,0xed,0xec,0x63,0xb6,0x1d,0x91,0x7b,0xc8,0xb3,0x46,0x1f,0x2f,0x3d,0xae,0x60,0x2c,0x68,0xbe,0x3b,0x35,0xe9,0x84,0xdb,0xfb,0xbc,0x9b,0xe2,0x2e,0xec,0xe4,0x83,0xf9,0x60,0xfa,0x7a,0x7a,0xe2,0xaa,0xc7,0x03,0xa6,0xa7,0x1b,0xf4,0x3c,0x9d,0x55,0xa4,0x00,0xe0,0xca,0x41,0xd1,0xfa,0x33,0xe3,0x2f,0x30,0x58,0x2b,0x1d,0x7d,0xa8,0x32,0x23,0xfc,0xcd,0x87,0x57,0xc9,0x14,0x8d,0x79,0xb8,0x46,0xd3,0x09,0xe5,0xd4,0x27,0xf8,0x32,0x39,0x12,0x04,0xc2,0x93,0xf4,0xd9,0x70,0xc1,0x84,0xf4,0x9b,0x71,0xe5,0x3f,0x6d,0xb2,0x14}	
	},

	//new1
	{
		{0x58,0x38,0x33,0x31,0x35,0x35,0x34,0x05,0x50,0x30,0x35,0x36},
		{0x3e,0x3e,0x96,0x89,0x04,0x11,0xaa,0x1c,0xf9,0x80,0x62,0x55,0x75,0x3f,0x59,0x6d,0x1c,0xfe,0x77,0x3c,0x5a,0x9e,0x3f,0xb4,0x20,0x40,0x20,0x28,0x9d,0xf1,0x61,0x08,0xfb,0x47,0x2c,0x9b,0xb9,0x31,0xfc,0x36,0xd1,0xb3,0xfa,0x82,0x63,0xac,0x8d,0x52,0x0a,0x22,0xdc,0x37,0x2c,0xd6,0xc4,0xd1,0x2d,0x33,0x56,0x51,0xe0,0x68,0x2f,0x9a,0x51,0x6d,0xfe,0xf9,0x63,0x2b,0x33,0xa4,0x94,0x62,0x26,0x20,0xb4,0x28,0xd0,0xd4,0x27,0xa8,0x5e,0x06,0xb2,0x11,0x95,0xe3,0x28,0xcf,0x1f,0xf2,0xf8,0x07,0x0a,0x88,0x5e,0xc5,0x3f,0x26,0x27,0xea,0xeb,0x2e,0x3f,0x40,0xfe,0xb4,0x59,0x63,0x1a,0xe7,0x5f,0x28,0x45,0x89,0xf6,0x6e,0x32,0xa5,0x74,0x05,0x02,0x5f,0x6d,0xc2,0x60,0xa6}
	},

	//new2
	{
		{0x19,0x32,0x33,0x31,0x35,0x35,0x34,0x05,0x50,0x30,0x35,0x36},
		{0xac,0x19,0xaf,0x9e,0x7f,0x10,0x41,0x49,0xf2,0x8c,0xbf,0x9b,0x70,0xd8,0xbb,0xed,0xf4,0xd5,0x6b,0x37,0xf6,0xc5,0x3b,0xdb,0x0e,0x77,0x41,0x44,0xbb,0x7a,0x41,0x71,0x67,0xaa,0x5b,0xe5,0x8c,0xbc,0xa0,0x51,0x45,0x0f,0xff,0xcd,0x23,0xbf,0xc8,0x05,0x54,0xec,0x79,0x31,0xd4,0xf3,0x9f,0x45,0x65,0x96,0x3c,0xc3,0x54,0xe7,0x8d,0xc4,0x12,0xc0,0xb9,0xa8,0x21,0x61,0x5c,0xf0,0x2e,0x50,0x50,0x37,0x3e,0xc0,0x5e,0x84,0xae,0xca,0x67,0xdb,0x2a,0xa7,0x4d,0x47,0x5d,0x7b,0x69,0x79,0x73,0x5e,0xf1,0x98,0x47,0x26,0x3f,0xb1,0xc7,0xb3,0x60,0x5f,0x60,0x30,0xdb,0xd8,0xae,0x91,0x69,0x6f,0xcb,0xd4,0x20,0x4b,0xe0,0x28,0x21,0x3b,0x40,0xf9,0xb1,0x67,0x77,0x82,0xf3,0x61}
	},

	//new3
	{
		{0xC8,0x37,0x33,0x31,0x35,0x35,0x34,0x05,0x50,0x30,0x35,0x36},
		{0x55,0xdc,0xcc,0xb2,0xfd,0x3e,0x65,0xd4,0x1e,0xc5,0xff,0x2f,0x02,0xe8,0x8d,0x48,0xb2,0xf7,0x49,0x89,0xf2,0xbc,0x07,0xc8,0x8e,0x25,0x9a,0x56,0x09,0xc3,0x85,0xb4,0x1e,0x82,0xfc,0x30,0xc2,0xc1,0xbe,0xf1,0xd3,0x1a,0x5b,0x36,0x1f,0xf5,0xca,0x01,0xb8,0xa2,0x1e,0x46,0xaa,0x16,0x91,0xfa,0x52,0x48,0xb4,0xb0,0xc3,0xfd,0x71,0xef,0xf4,0xd4,0x56,0x96,0x1f,0xa0,0x43,0xe5,0x83,0xb8,0x38,0xd1,0xe8,0xfc,0x13,0xa7,0xa9,0xcc,0x91,0x52,0xad,0x3f,0x8d,0xe5,0x7e,0x4e,0xec,0x63,0xb2,0x49,0x8d,0x41,0xa7,0x63,0x42,0x9a,0x8f,0x73,0x11,0xe6,0x8c,0x23,0xc5,0x62,0x07,0xeb,0x7d,0x8f,0xd7,0x73,0x79,0xb8,0x75,0x2d,0x39,0x38,0xaf,0xed,0xa2,0x52,0x6b,0xf3,0x81,0xb0}
	},

	//new4
	{
		{0x14,0x35,0x33,0x31,0x35,0x35,0x34,0x05,0x50,0x30,0x35,0x36},
		{0x6a,0xb6,0xcf,0x26,0x74,0xc6,0x74,0xc1,0x94,0x88,0x63,0x11,0x50,0x11,0x66,0xe3,0x0f,0x1d,0xd7,0x6a,0xc2,0xe7,0x51,0x2c,0x2b,0xaa,0x65,0x76,0xa1,0xec,0x5c,0xa0,0x02,0xd2,0x72,0x35,0x32,0xd0,0x7c,0x47,0x64,0xff,0x20,0xaf,0xa4,0x47,0x72,0xcf,0xfc,0x2b,0xee,0xc4,0x2b,0x70,0xe3,0x4c,0x2e,0x24,0x5d,0x95,0x53,0x7d,0x31,0x7c,0x0e,0x57,0x91,0x37,0xee,0xaf,0xc3,0x8b,0x1d,0x84,0xbb,0x43,0x7a,0x34,0x90,0x17,0xa3,0xb6,0xcc,0xda,0x53,0xe1,0x22,0x79,0xdc,0xf5,0xff,0x94,0x2d,0xc1,0x13,0xa6,0x22,0x70,0x32,0x07,0xa3,0x69,0x86,0x91,0x37,0xa4,0x2b,0xaf,0x83,0x0d,0x45,0x61,0x58,0x78,0x87,0x7d,0x2b,0x8b,0xcc,0x37,0x40,0x76,0xc5,0xf8,0xe9,0x1f,0x3f,0xce}
	},

	//new5
	{
		{0x6C,0x39,0x33,0x31,0x35,0x35,0x34,0x05,0x50,0x30,0x35,0x36},
		{0x63,0xee,0x1e,0x81,0x32,0x68,0xbd,0xad,0xc5,0xff,0xde,0x56,0xd3,0x41,0xa8,0x4e,0x40,0x60,0xd6,0xd1,0xd5,0xdb,0x82,0x5f,0x98,0x94,0xd2,0xe4,0x6b,0x66,0xcc,0x8d,0x2d,0x16,0xae,0x7c,0x91,0xc7,0xf6,0xd7,0x90,0x6d,0x9e,0xc4,0x3a,0x83,0x24,0x74,0xe5,0xfc,0x0a,0x89,0xa7,0x73,0x5e,0xf9,0x74,0xdf,0x97,0xbe,0xcb,0x5a,0xf3,0xe0,0xc9,0xc6,0x84,0x50,0x53,0xed,0x46,0x3b,0x59,0xdf,0xb7,0x34,0x71,0x26,0xde,0x25,0x46,0x29,0x4a,0x63,0x95,0xd0,0x0e,0x36,0x79,0xff,0xc8,0xeb,0x16,0xfc,0xb7,0xc0,0x44,0xd7,0xa6,0x8d,0xb8,0xa4,0xf0,0xea,0x5c,0xbe,0xfc,0x44,0x6a,0x20,0x3c,0xc5,0x80,0x03,0x1d,0xf5,0x5a,0x8d,0x9d,0x21,0x27,0x51,0x8a,0x5a,0x15,0xb6,0xbc,0x95}
	}

	};

//-----------------------------------------------
//				全局使用的变量，常量
//-----------------------------------------------
WORD UsePrintfFlag = 0x0000;
extern TUart_Para Uart_Para;
extern int m_SampleNum;
extern TSafeModePara SafeModePara;
extern DWORD SPIResetCount;//SPI复位次数计数器
extern SYS_PARA_1808 SysPara;

WORD JlinkRecTime = 0;	//jlink接收数据倒计时ms
BYTE JlinkRecBuf[CHMAX * 3 * SAMPLE_NUM + 10];
BYTE JlinkChval = 0;
DWORD JlinkRecCount = 0;
BYTE JlinkWaveState = 0; 		//周波传输状态

//-----------------------------------------------
//				本文件使用的变量，常量		
//-----------------------------------------------

//-----------------------------------------------
//				内部函数声明
//-----------------------------------------------
extern void GetParaInfo( BYTE *Ptr );
extern uint8_t ReadParaInfo(uint8_t* InputMessage,
    uint32_t			InputMessageLength,
    uint8_t* 			KValue,
    uint32_t			KeyLength,
    uint8_t* 			IV,
    uint32_t			IVSize,
    uint8_t* 			Header,
    uint32_t			HeaderSize,
    uint8_t* 			Tag,
    uint32_t			TagSize,
    uint8_t* 			OutputMessage);
extern int get_license(uint8_t *buf);
extern rt_err_t SwitchtoRtt(void) ;
extern rt_err_t SwitchtoUart(void) ;
extern void  save_license( uint8_t *write_buf );
extern void SaveMinFreezePoint( void );
extern WORD WriteEEPRom1(WORD Addr, WORD Length, BYTE * Buf);
//-----------------------------------------------
//				函数定义
//-----------------------------------------------


//--------------------------------------------------
//功能描述:  自定义命令
//         
//参数:      openall or closeall等等
//         
//返回值:    
//         
//备注:  输入cmd openall 或 cmd closeall
//--------------------------------------------------
static void cmd(int argc, char**argv)
{
	TFourByteUnion td;
	WORD i = 0,j = 0;
	BYTE Id[12],Parameter[12], Tag[16], OutputMessage[16],Temp,Num = 0;
	BYTE KValue[16] = {5, 1, 2, 6, 4, 3, 6, 7, 8, 6, 2, 4, 5, 2, 9, 0};
	BYTE IV[4] = {9, 8, 3, 3};
	BYTE Temp128[128];
	DWORD hchtest[20];
	TSysUNMsg SysUnMsg;
	TFreeEvent SysFree;
	TRealTimer t;
	DWORD TrueAddr,Offset,StartAddr,MinEndLen;
	BYTE License[132];
	#if(PROTOCOL_VERSION == 25)
	TFreezeCycleSafeRom Frzpara;
	TSpecificDevice SpcDev;
	#endif
	WORD wFreezeCycle = 0;


	if (argc < 2)
	{
		rt_kprintf("Please input'cmd <true|false>'\n");
		return;
	}

//--------------功能类命令------------------------//
	//1、所有功能
	if (!rt_strcmp(argv[1], "openall"))
	{
		UsePrintfFlag = 0x00FF; //'b:1111 1111
		rt_kprintf("open all!\n");
	}
	else if (!rt_strcmp(argv[1], "closeall"))
	{
		UsePrintfFlag = 0x0000;
		rt_kprintf("close all!\n");
	}

	//2、打印报文功能
	else if (!rt_strcmp(argv[1], "openprintf"))
	{
		UsePrintfFlag |= (0x0001 << 0);
		rt_kprintf("open printf!\n");
	}
	else if (!rt_strcmp(argv[1], "closeprintf"))
	{
		UsePrintfFlag &= (~(0x0001 << 0));
		rt_kprintf("close printf!\n");
	}

	//3、波形输出功能
	else if (!rt_strcmp(argv[1], "openwave"))
	{
		UsePrintfFlag |= (0x0001 << 1);
		rt_kprintf("open wave!\n");
	}
	else if (!rt_strcmp(argv[1], "closewave"))
	{
		UsePrintfFlag &= (~(0x0001 << 1));
		rt_kprintf("close wave!\n");
	}

	//4、测试EEP/FLASH读写次数
	else if (!rt_strcmp(argv[1], "openefp"))
	{
		UsePrintfFlag |= (0x0001 << 2);
		rt_kprintf("open EEP/FLASH count printf!\n");
	}
	else if (!rt_strcmp(argv[1], "closeefp"))
	{
		UsePrintfFlag &= (~(0x0001 << 2));
		rt_kprintf("close EEP/FLASH count printf!\n");
	}

	//5、算法打印功能
	else if (!rt_strcmp(argv[1], "openalg"))
	{
		UsePrintfFlag |= (0x0001 << 3);
		rt_kprintf("open algorithm printf!\n");
	}
	else if (!rt_strcmp(argv[1], "closealg"))
	{
		UsePrintfFlag &= (~(0x0001 << 3));
		rt_kprintf("close algorithm printf!\n");
	}

	//6、打印内存申请释放log
	else if (!rt_strcmp(argv[1], "openmemlog"))
	{
		UsePrintfFlag |= (0x0001 << 4);
		rt_kprintf("open algorithm printf!\n");
	}
	else if (!rt_strcmp(argv[1], "closememlog"))
	{
		UsePrintfFlag &= (~(0x0001 << 4));
		rt_kprintf("close algorithm printf!\n");
	}

	//6、周波电压电流输入功能
	else if (!rt_strcmp(argv[1], "openinput"))
	{
		UsePrintfFlag |= (0x0001 << 5);
		api_VariableInit();
		rt_kprintf("open vidata Input!\n");
	}
	else if (!rt_strcmp(argv[1], "closeinput"))
	{
		UsePrintfFlag &= (~(0x0001 << 5));
		rt_kprintf("close vidata input!\n");
	}
		
	//7、打印事件存储log
	else if (!rt_strcmp(argv[1], "openeventlog"))
	{
		UsePrintfFlag |= (0x0001 << 6);
		rt_kprintf("open event printf!\n");
	}
	else if (!rt_strcmp(argv[1], "closeeventlog"))
	{
		UsePrintfFlag &= (~(0x0001 << 6));
		rt_kprintf("close event printf!\n");
	}

	//8、打印冻结存储log
	else if (!rt_strcmp(argv[1], "openfreezelog"))
	{
		UsePrintfFlag |= (0x0001 << 7);
		rt_kprintf("open freeze printf!\n");
	}
	else if (!rt_strcmp(argv[1], "closefreezelog"))
	{
		UsePrintfFlag &= (~(0x0001 << 7));
		rt_kprintf("close freeze printf!\n");
	}


//--------------操作类命令------------------------//
	//1、初始化所有 43000900+43000800
	else if (!rt_strcmp(argv[1], "actioninit"))
	{
		copy_default_softflag();
		ReadSm4Para(1);
		api_FactoryInitEvent();
		api_FactoryInitFreeze();
		FactoryInitMeterClearPara();
		GetDefaultThresholdValue(1);
		sm4_InitKey();
		// 调用 API
		memset(&SafeModePara.Num, 0x00, sizeof(TSafeModePara));
		SafeModePara.Flag = 1;
		api_VWriteSafeMem( GET_SAFE_SPACE_ADDR(ProSafeRom.SafeModePara), sizeof(TSafeModePara), (BYTE *)&SafeModePara );

		#if(PROTOCOL_VERSION == 25)
		memset((BYTE*)&SpcDev,0xFF,sizeof(TSpecificDevice));
		SpcDev.bySpecificDeviceNum = 0;
		api_SetSpecificDeviceID(0x0B, (TSpecificDevice*)&SpcDev);										//设置特定设备ID为默认值
		Frzpara.Cycle = 0x000F;  						//默认值15分钟
		api_WriteFreezeAttribute(0x5002,(BYTE*)&Frzpara.Cycle);	
		#endif //#if(PROTOCOL_VERSION == 25)	
		rt_kprintf("action init ok!\n");
	}
	//2、打开厂内模式
	else if (!rt_strcmp(argv[1], "openfactory"))
	{
		api_SetSysStatus(eSYS_STATUS_INSIDE_FACTORY);
		rt_kprintf("action open factory ok!\n");
	}
	else if (!rt_strcmp(argv[1], "closefactory"))
	{
		api_ClrSysStatus(eSYS_STATUS_INSIDE_FACTORY);
		rt_kprintf("action close factory ok!\n");
	}
	//3、复位cpu
	else if (!rt_strcmp(argv[1], "actionreset"))
	{
		api_ResetCpu();
		rt_kprintf("action reset ok!\n");
	}
	//4、恢复默认芯片参数
	else if (!rt_strcmp(argv[1], "actionipinit"))//设置我们的license，用真实cpu id
	{
		GetParaInfo(Parameter);

		if (ReadParaInfo(Parameter, 12, KValue, 16, IV, 4, NULL, 0, Tag, sizeof(Tag), OutputMessage))// 加密
		{
			if(api_VWriteSafeMem(GET_SAFE_SPACE_ADDR(ParaInfoSafeRom.Para), sizeof(TParaInfoSafeRom), OutputMessage))
			{
				for(i=0;i<16;i++)
				{
					Temp = 0x33 + OutputMessage[i];//打印的是+33的，防止被读出直接使用
					rt_kprintf("%02X " ,Temp);
				}
				rt_kprintf("\n");
				rt_kprintf("action ip init ok!\n");
			}
		}
	}
	//5、擦除EEP全部扇区
	else if (!rt_strcmp(argv[1], "eraseeep"))
	{
		memset(&Temp128[0],0xFF,128);
		for(i=0;i<256;i++)//64KB,eep一分为二，每片256页，共计512页,eep总计64KB，每页128B，共计512页
		{
			CLEAR_WATCH_DOG;
			if(WriteEEPRom1(i*128 , 128, (BYTE *)&Temp128[0] ) != TRUE )
			{
				rt_kprintf("action EEP1 %d erase failed!\n",i);
			}
			if(WriteEEPRom2(i*128, 128, (BYTE *)&Temp128[0]) != TRUE )
			{
				rt_kprintf("action EEP2 %d erase failed!\n",i);
			}

			if((i % 64) == 0)
			{
				rt_kprintf("action EEP %d erase ok!\n",i);
			}
		}

		api_FactoryInitEvent();
		api_FactoryInitFreeze();
		memset(&SafeModePara.Num, 0x00, sizeof(TSafeModePara));
		SafeModePara.Flag = 1;
		api_VWriteSafeMem( GET_SAFE_SPACE_ADDR(ProSafeRom.SafeModePara), sizeof(TSafeModePara), (BYTE *)&SafeModePara );

		api_WriteFreeEvent(EEP_ERASE_EVENT,0);
		rt_kprintf("action EEP all erase ok!\n");
	}
	//5、擦除FLASH全部扇区,8MBflash,一共128块，每块16扇，每扇16页,4096字节;操作除去升级区域的其他6MB
	else if (!rt_strcmp(argv[1], "eraseflash"))
	{
		StartAddr = 0x00100000;
		MinEndLen = 1024*1024*6;

		for(i=0;i<(MinEndLen/SECTOR_SIZE);i++)
		{	
			CLEAR_WATCH_DOG;
			Offset = i*SECTOR_SIZE;
			TrueAddr = ((StartAddr+Offset) / SECTOR_SIZE) * SECTOR_SIZE;
			if( EraseExtFlashSector( CS_SPI_FLASH, TrueAddr ) != TRUE )
			{
				rt_kprintf("action flash %d erase failed!\n",i);
			}
			if((i % (128*2)) == 0)
			{
				rt_kprintf("action flash %d erase ok!\n",i);
			}
		}
		api_WriteFreeEvent(FLASH_ERASE_EVENT,0);
		rt_kprintf("action flash all erase ok!\n");
	}
	//6、密钥初始化为公钥
	else if (!rt_strcmp(argv[1], "actionikinit"))
	{
		copy_default_softflag();
		ReadSm4Para(1);
		sm4_InitKey();
		rt_kprintf("action ik init ok!\n");
	}
	//7、存储2880条冻结
	else if (!rt_strcmp(argv[1], "actionfreeze"))
	{
		// 确保参数存在
		if (argc > 2)
		{
			wFreezeCycle = 15;
			#if(PROTOCOL_VERSION == 25)
			api_GetFreezeCycle((BYTE*)&wFreezeCycle);
			#endif 

			for(i = 0; i < atoi(argv[2]); i++)
			{
				CLEAR_WATCH_DOG;
				api_TestComplementData();
				get_sys_time(&t);
				api_SecToAbsTime(((api_CalcInTimeRelativeMin(&t) / (BYTE)wFreezeCycle)*wFreezeCycle)*60, &t);
				api_WriteMeterTime(&t);
				ProcMinFreezeTask(0,(api_CalcInTimeRelativeMin(&t)+(i*wFreezeCycle)), eMAINTASK_FREEZE_MODE );
			}
			SaveMinFreezePoint();
			
			if(i>0)
			{
				api_SecToAbsTime((api_CalcInTimeRelativeMin(&t)+((i-1)*wFreezeCycle))*60, &t);
				api_WriteMeterTime(&t);
			}
			rt_kprintf("action freeze full ok!\n");
		}

	}
	//8、擦除APP区域
	else if (!rt_strcmp(argv[1], "eraseapp"))
	{
		StartAddr = 0x00000000;
		MinEndLen = 1024*1024*2;

		for(i=0;i<(MinEndLen/SECTOR_SIZE);i++)
		{	
			CLEAR_WATCH_DOG;
			Offset = i*SECTOR_SIZE;
			TrueAddr = ((StartAddr+Offset) / SECTOR_SIZE) * SECTOR_SIZE;
			if( EraseExtFlashSector( CS_SPI_FLASH, TrueAddr ) != TRUE )
			{
				rt_kprintf("action app %d erase failed!\n",i);
			}
			if((i % (128*2)) == 0)
			{
				rt_kprintf("action app %d erase ok!\n",i);
			}
		}
		api_WriteFreeEvent(FLASH_ERASE_EVENT,0);
		rt_kprintf("action flash all erase ok!\n");
	}

//--------------抄读类命令------------------------//
	//1、抄读程序版本号校验码
	else if (!rt_strcmp(argv[1], "getversion"))
	{	
		//BOOT版本号（2字节）
		td.b[1] = *((BYTE *)FLASH_ADDR_BOOT_VERSION + 1);
		td.b[0] = *((BYTE *)FLASH_ADDR_BOOT_VERSION);
		rt_kprintf("\tBOOT VERSION:%02X\n",td.w[0]);

		//BOOT校验码（2字节）
		td.w[0] = api_CheckCpuFlashSum(0x00);
		rt_kprintf("\tBOOT CHECK:%02X\n",td.w[0]);

		//APP版本号（2字节）
		td.b[0] = (BYTE)MODULE_VERSION;
		td.b[1] = (WORD)MODULE_VERSION>>8;
		rt_kprintf("\tAPP VERSION:%02X\n",td.w[0]);
		//APP校验码（2字节）
		td.w[0] = api_CheckCpuFlashSum(0x01);
		rt_kprintf("\tAPP CHECK:%02X\n",td.w[0]);

		rt_kprintf("get version ok!\n");
	}
	//2、获取CPU的ID
	else if (!rt_strcmp(argv[1], "getcpuid"))
	{
		GetParaInfo(Id);
		for(i = 0; i<sizeof(Id);i++)
		{
			rt_kprintf("%02X ",Id[i]);
		}
		rt_kprintf("\n");
		rt_kprintf("get cpu id ok!\n");
	}
	//3、读取complete变量值
    else if (!rt_strcmp(argv[1], "getcomval"))
	{
		rt_kprintf("get Complete = %d!\n",InitComplete);
	}
	//4、读取波特率变量值
    else if (!rt_strcmp(argv[1], "getbaud"))
	{
		rt_kprintf("get byRecResult = %d!\n",Uart_Para.byRecResult);
		rt_kprintf("get Baud = %d!\n",Uart_Para.nBaud);
	}
	//5、读取异常事件
	else if (!rt_strcmp(argv[1], "getsysunmsg"))
	{
		// 确保参数存在
		if (argc > 2)
		{
			// 将传入的参数转换为整数
			Num = atoi(argv[2]);

			// 打印消息
			for (i = 0; i < Num; i++)
			{
				// 调用 API
				api_ReadSysUNMsg(i, (BYTE*)&SysUnMsg);
				rt_kprintf("No %d type:0x%04X ",i, SysUnMsg.EventType);
				rt_kprintf("year:%02X,mon:%02X,day:%02X,hour:%02X,min:%02X,sec%02X\n", SysUnMsg.EventTime[5],SysUnMsg.EventTime[4],SysUnMsg.EventTime[3],SysUnMsg.EventTime[2],SysUnMsg.EventTime[1],SysUnMsg.EventTime[0]);
			}
			rt_kprintf("get sysunmsg ok!\n");
		}
		else
		{
			rt_kprintf("Error: No parameter provided for getsysunmsg\n");
		}
	}
	//6、读取周波点数
	else if (!rt_strcmp(argv[1], "getsamplenum"))
	{
		rt_kprintf("get m_SampleNum = %d!\n",m_SampleNum);
	}

	//7、读取EEP的使用空间
	else if (!rt_strcmp(argv[1], "geteepsize"))
	{
		hchtest[0]= GET_SAFE_SPACE_ADDR(ParaInfoSafeRom.Para);
		hchtest[1]= GET_SAFE_SPACE_ADDR(LicenseSafeRom.License);
		hchtest[2]= GET_SAFE_SPACE_ADDR(UpdatePara.CodeBufferLen);
		hchtest[3]= GET_SAFE_SPACE_ADDR(EventSafeRom.EventDataInfo);
		hchtest[4]= GET_SAFE_SPACE_ADDR(FreezeSafeRom.FreezeInfoRom);
		hchtest[5]= GET_SAFE_SPACE_ADDR(ReportSafeRom.ReportPara);
		hchtest[6]= GET_SAFE_SPACE_ADDR(ProSafeRom.SafeModePara);
		hchtest[7]= GET_SAFE_SPACE_ADDR(ReserveSafeRom[0]);

		hchtest[8]= GET_CONTINUE_ADDR(EventConRom.EventPara);
		hchtest[9]= GET_CONTINUE_ADDR(SysAbrEventConRom.SysUnMsgPoint);
		hchtest[10]= GET_CONTINUE_ADDR(SysFreeEventConRom.FreeEventPtr);
		hchtest[11]= sizeof(TSafeMem);
		hchtest[12]= sizeof(TConMem);

		for(i = 0;i<10;i++)
		{
			rt_kprintf("addr=0X%04X,len=%d \n",hchtest[i],(hchtest[i+1]-hchtest[i]));
		}
		rt_kprintf("addr=0X%04X,len=%d \n",hchtest[10],(hchtest[11]+hchtest[12]-hchtest[10]));
		rt_kprintf("hchtest[10]=%d\n",hchtest[11]);
		rt_kprintf("hchtest[11]=%d\n",hchtest[12]);
		rt_kprintf("get eepsize ok!\n");
	}

	//8、读取自由事件
	else if (!rt_strcmp(argv[1], "getsysfree"))
	{
		// 确保参数存在
		if (argc > 2)
		{
			// 将传入的参数转换为整数
			Num = atoi(argv[2]);

			// 打印消息
			for (i = 0; i < Num; i++)
			{
				// 调用 API
				api_ReadFreeEvent(i, (BYTE*)&SysFree);
				rt_kprintf("No %d type:0x%04X ",i, SysFree.EventType);
				rt_kprintf("SubEvent:0x%04X ",SysFree.SubEvent);
				rt_kprintf("year:%02X,mon:%02X,day:%02X,hour:%02X,min:%02X,sec%02X\n", SysFree.EventTime[5],SysFree.EventTime[4],SysFree.EventTime[3],SysFree.EventTime[2],SysFree.EventTime[1],SysFree.EventTime[0]);
			}
			rt_kprintf("get sysfree ok!\n");
		}
		else
		{
			rt_kprintf("Error: No parameter provided for get sysfree\n");
		}
	}

	//9、读取SPI复位次数
	else if (!rt_strcmp(argv[1], "getspirescnt"))
	{
		rt_kprintf(" SPIResetCnt = %d!\n",SPIResetCount);
	}

	//10、读取license
	else if (!rt_strcmp(argv[1], "getlicense"))
	{
		get_license(&License[0]);
		for(i = 0; i< 128; i++)
		{
			rt_kprintf(" 0x%02X",License[i]);
		}
		rt_kprintf("\nget_license is ok!\n");
	}

//--------------设置类命令------------------------//
	//1、设置算法程序license
	else if (!rt_strcmp(argv[1], "setlicense"))
	{
		GetParaInfo(Parameter);
		for(i = 0; i<(sizeof(gTAlgrothmPara)/sizeof(TAlgrothmPara));i++)
		{
			if(memcmp(&Parameter, &gTAlgrothmPara[i].Id, sizeof(Parameter) ) == 0)
			{
				save_license((uint8_t*)&gTAlgrothmPara[i].Parameter);
				rt_kprintf("set license ok!\n");
				break;
			}
		}
		if(i == (sizeof(gTAlgrothmPara)/sizeof(TAlgrothmPara)))
		{
			rt_kprintf("license is'n existence!\n");
		}


	}
	//2、设置complete变量值
    else if (!rt_strcmp(argv[1], "resetcomval"))
	{
		InitComplete = 0;
		rt_kprintf("set InitComplete=0 ok!\n");
	}

	//3、设置安全模式参数
	else if(!rt_strcmp(argv[1], "setsafepara"))
	{
		// 确保参数存在
		if (argc > 2)
		{
			// 将传入的参数转换为整数
			Num = atoi(argv[2]);

			// 调用 API
            memset(&SafeModePara.Num, 0x00, sizeof(TSafeModePara));
            SafeModePara.Flag = Num;
			api_VWriteSafeMem( GET_SAFE_SPACE_ADDR(ProSafeRom.SafeModePara), sizeof(TSafeModePara), (BYTE *)&SafeModePara );

			rt_kprintf("set setsafepara ok!\n");
		}
		else
		{
			rt_kprintf("Error: No parameter provided for setsafepara\n");
		}

	}
	//2、设置打印通道
	else if (!rt_strcmp(argv[1], "setchannel"))
	{
		if (argc < 2) 
		{
			rt_kprintf("Usage: switch_channel [rtt|uart]\n");
			return;
		}

		if (rt_strcmp(argv[2], "rtt") == 0) 
		{
			SwitchtoRtt();
		}
		else if (rt_strcmp(argv[2], "uart") == 0) 
		{
			SwitchtoUart();
		}
		else 
		{
			rt_kprintf("Invalid channel name!\n");
		}
	}
	
	//3、设置电压电流系数，目前仅涉及了单相
	//cmd setuik 3698166 99985 10 10 （宁浩北京录播）   
	//cmd setuik 1 1 4 4（宁浩合成）  
	//cmd setuik 356983488 57135464 12 12(校园表默认) 
	//cmd setuik 294856851 57667874 12 12(物联表默认) 
	//cmd setuik 2672848 2486532 10 10（宁浩三相录播）
	//cmd setuik 2670369 -1005333 10 11(北京清华联单相录播)
	//cmd setuik 2671554 2498945 10 11(北京石景山3相表1)
	//cmd setuik 2670369 2503047 10 11(北京石景山3相表2)
	else if(!rt_strcmp(argv[1], "setuik"))
	{
		if (argc < (2+MAX_PHASE*4))
		{
			rt_kprintf("Usage: setuik [u|i]\n");
			return;
		}

		for(i = 2; i<(2 + MAX_PHASE*2); i++)
		{
			if(i<5)
			{
				if ((argv[i] != 0) && (argv[MAX_PHASE*2 + i] != 0)) //电压系数
				{
					EU_factor[i-2] = atof(argv[i]);
					for(j = 0; j<atoi(argv[MAX_PHASE*2 + i]);j++)
					{
						EU_factor[i-2] /= 10;
					}
				}
			}
			else
			{
				if ((argv[i] != 0) && (argv[MAX_PHASE*2 + i] != 0)) //电流系数
				{
					EI_factor[i-5] = atof(argv[i]);
					for(j = 0; j<atoi(argv[MAX_PHASE*2 + i]);j++)
					{
						EI_factor[i-5] /= 10;
					}
				}
			}
		}

		rt_kprintf("setuik ok!\n");
		InitComplete = 1;
	}

	
//--------------其他类命令------------------------//
	else
	{
		rt_kprintf("Please input'cmd <true|false>'\n");
	}
}

MSH_CMD_EXPORT(cmd, cmd_printf sample: cmd_printf <true|false>);


//-----------------------------------------------
//函数功能: JLINK有关的大循环任务
//
//参数:		无 
//                 
//返回值: 	无
//		   
//备注:   
//-----------------------------------------------			
void api_JlinkTask(void)
{	
	//250ms更新
	if( api_GetTaskFlag(eTASK_JLINK_ID,eFLAG_250_MS) == TRUE )
	{
		api_ClrTaskFlag(eTASK_JLINK_ID,eFLAG_250_MS);

		if(((UsePrintfFlag >> 5) & 0x0001) == 0x0001) //开启了周波输入功能
		{
			if(JlinkRecTime > 0)
			{
				JlinkRecTime -= 250;
			}

			if(JlinkRecTime == 0)
			{
				JlinkRecCount = 0;
				JlinkWaveState = 0;
				Last_frame_num = 0xffff;
				memset(&JlinkRecBuf,0,sizeof(JlinkRecBuf));
			}
		}
	}
}