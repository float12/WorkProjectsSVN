# -*- coding: gbk -*-
import re
from openpyxl import load_workbook, Workbook

def parse_total_str(total_str):
    """解析原始数据字符串，返回各功率/电流/电压列表"""
    pattern = r"点\s+([-\d.\s]+?)(?=每|$)"
    matches = re.findall(pattern, total_str, re.S)
    data_lists = [list(map(float, m.split())) for m in matches]
    if len(data_lists) < 5:
        raise ValueError("数据解析失败，数据组数不足5")
    return {
        "appr_pwr_list": data_lists[0],
        "act_pwr_list": data_lists[1],
        "react_pwr_list": data_lists[2],
        "iRms_list": data_lists[3],
        "uRms_list": data_lists[4]
    }

def extract_same_data(data, difFactor, min_group_len=4, print_group=False,data_name =None):
    """分组提取相近数据，返回每组中间4个或全部（不足4个）"""
    groups = []
    current_group = [data[0]]
    for i in range(1, len(data)):
        if abs(data[i] - data[i-1]) < abs(data[i-1])*difFactor or abs(data[i] - data[i-1]) < 2:
            current_group.append(data[i])
        else:
            n = len(current_group)
            if n <= min_group_len:
                mid_nums = current_group[:]
            else:
                start = n // 2 - 2
                if start < 0: start = 0
                mid_nums = current_group[start:start + min_group_len]
            groups.append(mid_nums)
            current_group = [data[i]]

    # ? 处理最后一组
    n = len(current_group)
    if n <= min_group_len:
        mid_nums = current_group[:]
    else:
        start = n // 2 - 2
        if start < 0: start = 0
        mid_nums = current_group[start:start + min_group_len]
    groups.append(mid_nums)

    groups_filtered = [g for g in groups if len(g) >= min_group_len]
    if print_group:
        print(data_name)
        for g in groups_filtered:
            print(g)
    return groups_filtered

def check_group_count(data_group, expect_count, name, writeExcelFlag):
    """检查分组数量是否符合预期"""
    if len(data_group) != expect_count:
        print(f"{name} len err")
        return 0
    return writeExcelFlag

def write_to_excel(excel_name, sheetName, UIPoints, power_start_index, 
                   appr_pwr_list, act_pwr_list, react_pwr_list, uRms_list, iRms_list):
    """写入数据到Excel"""
    wb = None
    try:
        try:
            wb = load_workbook(excel_name)
            sheet = wb[sheetName]
        except FileNotFoundError:
            wb = Workbook()
            sheet = wb.active
            sheet.title = sheetName

        for i in range(2, 2+UIPoints):
            # if i != 2:
                # U RMS
                # val = " ".join(map(str, uRms_list[i - 3]))
                # sheet.cell(row=i+8, column=2, value=val)
                # I RMS
                # val = " ".join(map(str, iRms_list[i - 3]))
                # sheet.cell(row=i+8, column=6, value=val)

            # 视在功率
            val = " ".join(map(str, appr_pwr_list[power_start_index + i - 2]))
            sheet.cell(row=9 - i, column=5, value=val)
            # 1.0有功
            val = " ".join(map(str, act_pwr_list[power_start_index + (i - 2)*3]))
            sheet.cell(row=9 - i, column=5 + 6, value=val)
            # 1.0无功
            val = " ".join(map(str, react_pwr_list[power_start_index + (i - 2)*3]))
            sheet.cell(row=9 - i, column=5 + 6 + 5, value=val)
            # 0.5有功
            val = " ".join(map(str, act_pwr_list[power_start_index + (i - 2)*3 + 1]))
            sheet.cell(row=9 - i, column=5 + 6 + 5 + 5, value=val)
            # 0.5无功
            val = " ".join(map(str, react_pwr_list[power_start_index + (i - 2)*3 + 1]))
            sheet.cell(row=9 - i, column=5 + 6 + 5 + 5 + 5, value=val)
            # 0.8有功
            val = " ".join(map(str, act_pwr_list[power_start_index + (i - 2)*3 + 2]))
            sheet.cell(row=9 - i, column=5 + 6 + 5 + 5 + 5 + 5, value=val)
            # 0.8无功
            val = " ".join(map(str, react_pwr_list[power_start_index + (i - 2)*3 + 2]))
            sheet.cell(row=9 - i, column=5 + 6 + 5 + 5 + 5 + 5 + 5, value=val)
    finally:
        if wb:
            wb.save(excel_name)
            wb.close()

def process_and_write(total_str, excel_name, sheetName, UIPoints, power_start_index):
    # 解析数据
    data = parse_total_str(total_str)
    appr_pwr_list = extract_same_data(data["appr_pwr_list"], 0.04, print_group=True,data_name = "视在")
    act_pwr_list = extract_same_data(data["act_pwr_list"], 0.04, print_group=True,data_name = "有功")
    react_pwr_list = extract_same_data(data["react_pwr_list"], 0.06, print_group=True,data_name = "无功")
    uRms_list = extract_same_data(data["uRms_list"], 0.05, print_group=True,data_name ="urms")
    iRms_list = extract_same_data(data["iRms_list"], 0.05, print_group=True,data_name ="Irms")

    writeExcelFlag = 1
    writeExcelFlag = check_group_count(appr_pwr_list, power_start_index+UIPoints, "appr_pwr_list", writeExcelFlag)
    writeExcelFlag = check_group_count(act_pwr_list, power_start_index+UIPoints*3, "act_pwr_list", writeExcelFlag)
    writeExcelFlag = check_group_count(react_pwr_list, power_start_index+UIPoints*3, "react_pwr_list", writeExcelFlag)

    if writeExcelFlag:
        write_to_excel(
            excel_name, sheetName, UIPoints, power_start_index,
            appr_pwr_list, act_pwr_list, react_pwr_list, uRms_list, iRms_list
        )

# ----------------- 主流程入口 -----------------
if __name__ == "__main__":
    sheetName = "表2-A相"
    excel_name = "D:\\work\\project\\WaveRecord\\单相录波工装点检表.xlsx"
    power_start_index = 0
    UIPoints = 6
    total_str = '''


每50周波平均 视在功率 前 500000 点
53.381 54.759 54.930 54.958 54.956 54.964 54.947 54.960 54.960 54.957 54.957 54.952 54.955 54.975 54.946 55.088 55.054 55.031 55.032 55.038 55.038 55.047 55.027 55.031 55.029 55.039 55.029 55.032 55.040 55.025 55.036 55.025 55.024 55.034 55.030 55.016 54.916 54.870 54.894 54.900 54.901 54.901 54.893 54.889 54.904 54.896 54.905 54.906 54.897 54.904 54.901 54.899 54.905 54.908 54.897 66.773 92.989 104.953 108.607 109.587 109.825 109.901 109.916 109.912 109.915 109.916 109.919 110.002 109.927 109.936 109.932 109.926 109.937 109.931 109.933 109.897 109.894 110.079 110.010 110.006 110.000 110.002 110.000 109.995 109.995 109.998 109.996 109.988 110.002 109.998 109.992 109.995 109.985 109.991 109.981 109.982 109.989 109.908 109.771 109.768 109.841 109.850 109.844 109.859 109.866 109.859 109.863 109.858 109.863 109.866 109.868 109.879 109.868 109.864 109.875 109.875 109.883 109.875 149.230 211.629 219.252 219.820 219.858 219.881 219.892 219.883 219.871 219.874 219.861 219.869 219.869 219.857 219.878 219.866 219.861 219.842 219.849 219.833 219.839 219.798 219.953 219.944 219.918 219.918 219.915 219.904 219.913 219.910 219.913 219.903 219.909 219.891 219.893 219.897 219.900 219.890 219.881 219.882 219.889 219.845 219.595 219.567 219.805 219.769 219.786 219.800 219.803 219.799 219.814 219.811 219.811 219.804 219.815 219.817 219.816 219.807 219.801 219.807 219.816 216.867 28.279 3.736 8.280 40.982 174.505 404.545 523.770 546.589 549.464 549.735 549.691 549.674 549.661 549.660 549.634 549.647 549.651 549.658 549.597 549.586 549.548 549.991 549.929 549.769 549.710 549.629 549.645 549.687 549.617 549.637 549.696 549.601 549.634 549.586 549.582 549.597 549.602 549.614 549.572 549.633 549.381 549.031 549.498 549.795 549.516 549.650 549.683 549.647 549.665 549.616 549.658 549.651 549.648 549.628 549.548 549.645 549.592 549.596 549.611 549.567 596.559 861.177 1025.047 1079.489 1094.265 1097.940 1098.827 1099.098 1099.063 1099.190 1099.177 1099.081 1099.041 1098.980 1098.973 1098.959 1098.968 1098.996 1098.931 1098.956 1099.225 1100.343 1099.953 1099.306 1099.169 1099.081 1099.071 1099.107 1099.056 1099.090 1099.132 1099.053 1099.055 1099.094 1099.114 1099.132 1099.120 1099.119 1099.138 1099.174 1098.543 1099.025 1099.895 1099.274 1099.028 1099.198 1099.223 1099.250 1099.242 1099.201 1099.198 1099.202 1099.167 1099.181 1099.094 1099.058 1099.046 1099.067 1099.064 1099.047 302.818 11.863 52.421 402.634 2115.441 3981.479 4365.064 4393.874 4395.371 4395.194 4395.279 4395.085 4394.929 4394.880 4395.033 4394.927 4394.961 4394.942 4394.991 4395.202 4395.749 4402.227 4400.198 4395.692 4395.597 4395.767 4395.643 4395.926 4395.705 4395.828 4395.782 4395.930 4395.856 4395.955 4396.021 4395.994 4396.327 4396.217 4396.096 4396.267 4395.841 4396.676 4397.970 4395.974 4395.577 4395.712 4395.662 
每50周波平均 有功功率 前 500000 点
53.381 54.759 54.930 54.958 54.955 54.963 54.947 54.959 54.960 54.956 54.957 54.951 54.954 54.975 53.899 42.656 27.769 27.480 27.487 27.490 27.489 27.495 27.480 27.480 27.488 27.491 27.487 27.483 27.481 27.481 27.483 27.474 27.489 27.484 30.430 47.440 54.200 46.610 43.968 43.944 43.948 43.950 43.943 43.940 43.954 43.945 43.953 43.949 43.945 43.956 43.944 43.946 43.954 43.957 43.945 59.184 92.704 104.953 108.607 109.587 109.825 109.900 109.916 109.912 109.915 109.915 109.919 109.995 109.927 109.936 109.932 109.926 109.937 109.931 109.933 109.882 102.032 68.966 54.984 54.990 54.971 54.987 54.971 54.975 54.979 54.975 54.980 54.974 54.975 54.981 54.979 54.962 54.954 54.959 54.957 54.956 59.287 92.727 108.404 94.361 87.971 87.902 87.897 87.904 87.914 87.905 87.918 87.913 87.921 87.924 87.927 87.932 87.923 87.919 87.930 87.932 87.937 87.933 132.088 210.788 219.251 219.820 219.858 219.881 219.891 219.883 219.871 219.874 219.861 219.869 219.869 219.857 219.878 219.866 219.861 219.842 219.849 219.833 219.839 212.737 159.449 109.299 109.911 109.926 109.929 109.926 109.935 109.912 109.919 109.913 109.905 109.894 109.893 109.883 109.890 109.878 109.873 109.865 109.874 112.539 172.818 215.705 196.563 175.590 175.866 175.874 175.871 175.873 175.882 175.890 175.892 175.879 175.888 175.889 175.890 175.887 175.874 175.881 175.891 173.546 22.684 2.888 7.443 40.902 174.500 404.543 523.769 546.589 549.464 549.735 549.691 549.674 549.661 549.660 549.633 549.647 549.651 549.658 549.597 549.586 547.276 473.371 301.112 274.938 274.796 274.768 274.737 274.760 274.724 274.730 274.745 274.698 274.702 274.685 274.683 274.677 274.691 274.711 274.676 274.701 290.889 454.951 542.453 478.010 439.875 439.788 439.824 439.807 439.808 439.776 439.808 439.799 439.797 439.779 439.711 439.790 439.739 439.738 439.745 439.711 496.633 845.823 1025.044 1079.487 1094.265 1097.940 1098.827 1099.098 1099.063 1099.190 1099.177 1099.081 1099.041 1098.980 1098.973 1098.959 1098.968 1098.996 1098.931 1098.956 1091.084 919.202 583.530 549.181 549.301 549.232 549.233 549.255 549.243 549.250 549.266 549.243 549.263 549.270 549.306 549.324 549.349 549.350 549.362 549.409 618.917 961.878 1084.218 926.182 879.867 879.511 879.559 879.578 879.556 879.525 879.510 879.507 879.472 879.475 879.384 879.355 879.313 879.345 879.340 879.318 241.172 8.878 45.084 400.330 2115.384 3981.474 4365.063 4393.874 4395.370 4395.193 4395.278 4395.084 4394.928 4394.879 4395.032 4394.926 4394.960 4394.941 4394.990 4395.201 4383.235 3851.826 2460.430 2198.014 2195.529 2195.778 2195.682 2195.893 2195.844 2195.960 2196.028 2196.123 2196.160 2196.340 2196.392 2196.453 2196.659 2196.701 2196.709 2196.856 2292.178 3567.732 4335.185 3869.909 3516.810 3517.522 3517.449 3517.532 3516.522 3517.549
每50周波平均 无功功率 前 500000 点
0.077 0.067 0.066 0.062 0.078 0.068 0.063 0.067 0.090 0.061 0.086 0.067 0.062 0.086 7.843 33.770 47.511 47.678 47.676 47.680 47.681 47.688 47.673 47.679 47.672 47.681 47.672 47.678 47.688 47.671 47.682 47.675 47.665 47.679 45.603 26.495 7.542 28.242 32.864 32.906 32.905 32.902 32.898 32.894 32.900 32.900 32.904 32.911 32.901 32.898 32.909 32.903 32.902 32.902 32.901 29.477 4.293 0.160 0.106 0.061 0.055 0.052 0.053 0.059 0.061 0.053 0.047 0.236 0.107 0.060 0.058 0.051 0.059 0.059 0.059 0.588 36.968 84.296 95.282 95.275 95.280 95.273 95.279 95.271 95.269 95.275 95.270 95.264 95.279 95.272 95.266 95.279 95.271 95.276 95.266 95.267 92.310 56.420 14.864 54.261 65.772 65.880 65.877 65.893 65.891 65.891 65.881 65.878 65.876 65.878 65.877 65.889 65.881 65.881 65.885 65.882 65.888 65.881 66.461 11.483 0.319 0.311 0.261 0.280 0.236 0.315 0.053 0.047 0.047 0.048 0.048 0.051 0.046 0.044 0.047 0.052 0.048 0.041 0.039 44.228 147.504 190.847 190.482 190.473 190.469 190.458 190.462 190.472 190.472 190.463 190.475 190.461 190.463 190.474 190.473 190.469 190.461 190.467 190.470 188.719 131.007 33.771 92.448 132.151 131.823 131.835 131.845 131.834 131.847 131.831 131.829 131.834 131.841 131.843 131.840 131.830 131.837 131.838 131.839 130.044 16.850 2.200 3.430 1.258 0.134 0.057 0.047 0.059 0.040 0.041 0.041 0.043 0.044 0.037 0.041 0.050 0.038 0.042 0.047 0.036 28.431 266.344 457.588 476.081 476.096 476.020 476.056 476.091 476.031 476.051 476.110 476.028 476.064 476.018 476.013 476.035 476.033 476.035 476.007 476.063 464.925 294.968 75.007 260.897 329.354 329.699 329.706 329.669 329.697 329.659 329.685 329.686 329.684 329.675 329.631 329.688 329.669 329.675 329.692 329.663 327.100 119.682 1.554 1.654 0.158 0.134 0.158 0.124 0.141 0.144 0.148 0.120 0.153 0.147 0.154 0.162 0.161 0.140 0.133 0.157 83.714 579.579 929.361 952.298 952.071 952.010 951.997 952.027 951.975 952.009 952.049 951.971 951.962 952.003 952.005 952.016 951.988 951.986 952.001 952.015 901.431 502.832 155.813 580.528 658.550 659.316 659.292 659.312 659.327 659.301 659.316 659.328 659.315 659.335 659.312 659.290 659.325 659.318 659.320 659.321 182.949 6.561 25.965 25.079 4.917 3.577 1.563 1.393 1.487 1.531 1.529 1.578 1.609 1.621 1.668 1.672 1.653 1.667 1.704 1.722 176.656 2015.933 3621.090 3806.666 3808.005 3808.058 3807.970 3808.175 3807.949 3808.024 3807.932 3808.047 3807.941 3807.951 3807.998 3807.931 3808.196 3808.045 3807.901 3808.013 3744.856 2475.173 622.708 1984.029 2636.797 2636.156 2636.171 2636.256 2636.341 2636.322
每50周波平均 I RMS 前 500000 点
0.243 0.249 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.304 0.423 0.477 0.494 0.498 0.499 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.501 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.499 0.499 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.679 0.962 0.997 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 0.999 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 1.000 0.999 0.998 1.000 0.999 0.999 1.000 1.000 0.999 1.000 1.000 1.000 0.999 1.000 1.000 1.000 0.999 0.999 0.999 0.999 0.986 0.129 0.017 0.038 0.186 0.793 1.839 2.382 2.485 2.498 2.500 2.500 2.499 2.499 2.499 2.499 2.499 2.499 2.500 2.499 2.499 2.499 2.501 2.501 2.500 2.500 2.500 2.500 2.500 2.500 2.500 2.500 2.499 2.500 2.499 2.499 2.499 2.499 2.499 2.499 2.499 2.498 2.497 2.499 2.500 2.499 2.499 2.499 2.499 2.499 2.499 2.499 2.499 2.499 2.499 2.499 2.499 2.499 2.499 2.499 2.499 2.713 3.916 4.661 4.909 4.976 4.993 4.997 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.999 5.004 5.002 4.999 4.999 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.995 4.997 5.001 4.998 4.997 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.998 4.997 4.998 4.998 4.998 4.998 1.377 0.054 0.238 1.831 9.621 18.107 19.852 19.983 19.990 19.989 19.990 19.989 19.988 19.988 19.989 19.988 19.988 19.988 19.988 19.989 19.991 20.020 20.010 19.990 19.989 19.989 19.988 19.989 19.988 19.988 19.988 19.989 19.988 19.989 19.989 19.988 19.990 19.989 19.989 19.990 19.988 19.992 19.998 19.989 19.989 19.989 19.989 
每50周波平均 U RMS 前 500000 点
219.903 219.916 219.914 219.909 219.916 219.922 219.919 219.923 219.917 219.921 219.923 219.927 219.928 219.933 219.932 219.934 219.933 219.936 219.937 219.939 219.937 219.940 219.938 219.939 219.937 219.939 219.932 219.933 219.929 219.928 219.926 219.925 219.922 219.920 219.916 219.915 219.911 219.906 219.904 219.900 219.897 219.896 219.895 219.895 219.890 219.891 219.891 219.894 219.893 219.895 219.893 219.896 219.896 219.901 219.900 219.901 219.905 219.908 219.909 219.913 219.913 219.920 219.918 219.922 219.923 219.924 219.927 219.998 219.931 219.931 219.931 219.933 219.933 219.933 219.933 219.932 219.933 219.936 219.932 219.932 219.927 219.928 219.924 219.921 219.920 219.920 219.913 219.910 219.908 219.908 219.902 219.901 219.896 219.896 219.895 219.892 219.888 219.889 219.887 219.888 219.887 219.887 219.887 219.890 219.891 219.891 219.892 219.893 219.895 219.898 219.899 219.904 219.904 219.909 219.908 219.915 219.915 219.920 219.919 219.923 219.925 219.928 219.927 219.930 219.931 219.931 219.931 219.934 219.931 219.933 219.929 219.932 219.930 219.926 219.923 219.921 219.920 219.918 219.917 219.912 219.910 219.899 219.900 219.900 219.899 219.898 219.895 219.896 219.892 219.892 219.888 219.891 219.888 219.888 219.887 219.889 219.888 219.890 219.891 219.893 219.896 219.899 219.893 219.904 219.902 219.906 219.910 219.910 219.915 219.917 219.916 219.921 219.922 219.923 219.926 219.926 219.925 219.931 219.932 219.933 219.931 219.931 219.928 219.929 219.929 219.930 219.926 219.928 219.923 219.923 219.919 219.918 219.915 219.914 219.909 219.909 219.905 219.904 219.897 219.902 219.897 219.894 219.891 219.892 219.891 219.890 219.890 219.890 219.887 219.892 219.891 219.891 219.889 219.897 219.898 219.895 219.898 219.905 219.906 219.909 219.910 219.916 219.917 219.923 219.920 219.920 219.925 219.930 219.931 219.925 219.934 219.934 219.928 219.926 219.922 219.931 219.932 219.931 219.928 219.927 219.925 219.925 219.920 219.919 219.914 219.913 219.909 219.910 219.906 219.907 219.904 219.902 219.896 219.897 219.893 219.894 219.892 219.894 219.890 219.892 219.891 219.889 219.888 219.889 219.890 219.893 219.894 219.897 219.897 219.901 219.903 219.906 219.908 219.909 219.910 219.915 219.916 219.919 219.921 219.924 219.923 219.923 219.931 219.929 219.925 219.926 219.930 219.936 219.932 219.935 219.933 219.932 219.929 219.928 219.925 219.925 219.919 219.919 219.916 219.914 219.907 219.907 219.902 219.897 219.886 219.886 219.882 219.881 219.880 219.880 219.879 219.879 219.878 219.878 219.878 219.880 219.881 219.882 219.882 219.885 219.886 219.892 219.897 219.894 219.902 219.908 219.910 219.914 219.915 219.918 219.919 219.922 219.922 219.919 219.924 219.928 219.927 219.926 219.926 219.929 219.928 219.920 219.916 219.915 219.904 219.904 219.902

'''
process_and_write(total_str,excel_name,sheetName,UIPoints,power_start_index)
